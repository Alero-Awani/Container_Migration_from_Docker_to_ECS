version: 0.2
phases:
  install:
    runtime-versions:
      python: 3.8
    commands:
      - echo "Installing aws cli"
      - sudo apt update
      - sudo add-apt-repository universe
      - sudo apt install python3-pip
      - sudo apt install jq gettext bash-completion moreutils -y
      - sudo pip install --upgrade awscli && hash -r
      - echo "Performing manual install of compose cli"
      - sudo apt-get update -y &&
      - sudo apt-get install -y \
      - apt-transport-https \
      - ca-certificates \
      - curl \
      - gnupg-agent \
      - software-properties-common &&
      - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - &&
      - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" &&
      - sudo apt-get update -y &&
      - sudo sudo apt-get install docker-ce docker-ce-cli containerd.io -y &&
      - sudo curl -L https://raw.githubusercontent.com/docker/compose-cli/main/scripts/install/install_linux.sh | sh &&
      - sudo groupadd docker
      - sudo usermod -aG docker ubuntu
      - sudo curl -L https://github.com/docker/compose/releases/download/v2.9.0/docker-compose-linux-x86_64 -o /usr/bin/docker-compose
      - sudo chmod +x /usr/bin/docker-compose
      - sudo add-apt-repository universe
      - sudo apt install python3-pip -y
      - export PATH="${HOME}/bin:$PATH"
  pre_build:
    commands:
      - echo Logging in to Docker Hub...
      - docker login --username $DOCKERHUB_USERNAME --password $DOCKERHUB_PASSWORD
      - export ACCOUNT_ID=$(aws sts get-caller-identity --output text --query Account)
      - export STS_RESPONSE=$(aws sts assume-role --role-arn arn:aws:iam::${ACCOUNT_ID}:role/ec2_role --role-session-name my-session2 --duration-seconds 3600)
      - export AWS_ACCESS_KEY_ID=$(echo $STS_RESPONSE | jq .AccessKeyId | tr -d \")
      - export AWS_SECRET_ACCESS_KEY=$(echo $STS_RESPONSE | jq .SecretAccessKey | tr -d \")
      - export AWS_SESSION_TOKEN=$(echo $STS_RESPONSE | jq .Token | tr -d \")
      - echo "Create Docker ECS context"
      - docker/docker context create ecs ecs-workshop --from-env
      - echo "Change context to use ECS context"
      - docker/docker context use ecs-workshop

  build:
    commands:
      - DOCKER_HUB_ID=${DOCKERHUB_USERNAME} DOCKER_PULL_SECRETS_MANAGER=${DOCKER_PULL_SECRETS_MANAGER} docker/docker compose -f docker-compose.yaml -f  docker-compose.prod.migrate.yaml -p ${PROJECT_NAME} up
  
  post_build:
    commands:
      - echo "deploy successful"